* Useful packages
** Fold-this can be used to fold the selected region
   #+begin_src emacs-lisp
     (el-get 'sync 'fold-this)
     (require 'fold-this)
   #+end_src

** popup can be used display folded region
   We can use popup to display the folded region as a popup
   instead of displaying it in the echo area
   #+begin_src emacs-lisp
     (el-get 'sync 'popup)
     (require 'popup)
   #+end_src
   

* Setup help at point to display local-help
  Setup help-at-pt to display help when idle, in case of folded code
  it will actually execute the code to display the [[folded_code][folded code popup]].
  #+begin_src emacs-lisp
       (require 'help-at-pt)
       (setq help-at-pt-display-when-idle t)
       (help-at-pt-set-timer)
  #+end_src
   

* Helper functions
** Function to display folded area as a popup <<folded_code>>
   hs-mode mode allows us to additional data to the overlay, this can 
   be used to set overlay's 'help-echo' property so that 'help-at-pt'
   can then display it after certain delay. In our case we set help
   echo to a function which when called displays a popup with folded code.

   Further we can toggle the folded region with 'C-g' or '<return>' by setting
   keymap property of the overlay

   #+begin_src emacs-lisp
     (defvar iqbal-folding-keymap (make-sparse-keymap))
     (define-key iqbal-folding-keymap (kbd "<return>") 'hs-toggle-hiding)
     (define-key iqbal-folding-keymap (kbd "C-g") 'hs-toggle-hiding)
     
     (defun iqbal-display-folded-content (ov)
       (overlay-put ov 'display "...")
       (overlay-put ov 'keymap iqbal-folding-keymap))
     
     (setq hs-set-up-overlay 'iqbal-display-folded-content)
   #+end_src
   
** Function to fold code at current indentation <<fold_indentation>>
   The following code was borrowed from [[http://www.emacswiki.org/emacs/HideShow#toc5][EmacsWiki]] and modified a bit
   #+begin_src emacs-lisp
     (defun iqbal-hide-current-indentation ()
       (interactive)
       (set-selective-display
            (unless selective-display
          (progn
            (back-to-indentation)
            (current-column)))))
   #+end_src

** Combining fold-this and [[fold_indentation][indent according to indentation]]
   
   #+begin_src emacs-lisp
     (defun iqbal-fold-this-or-fold-indent ()
       "Folds the region if mark is active otherwise fold the current indent"
       (interactive)
       (if mark-active
           (fold-this (region-beginning)
                          (region-end))
         (iqbal-hide-current-indentation)))
   #+end_src
     

* Unfold code when searching
  #+begin_src emacs-lisp
      (setq hs-isearch-open t)
  #+end_src


* Global keys for code folding
  #+begin_src emacs-lisp
      (global-set-key (kbd "C-\\") 'hs-toggle-hiding)
      (global-set-key (kbd "C-x C-\\") 'iqbal-fold-this-or-fold-indent)
  #+end_src
  
